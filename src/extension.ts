import * as vscode from 'vscode';
import * as fs from 'fs';
import * as path from 'path';

type MergedKeywords =  { [key: string]: { description: string, file: string } }

// Vari√°vel global que cont√©m os dados das keywords
let mergedKeywords: MergedKeywords = {};
let availableVersions: string[];

let outLog: vscode.OutputChannel;

function getExtensionConfig() {
    const config = vscode.workspace.getConfiguration('cmghelp');
    const rootPrefix = config.get<string>('rootPrefix');
    const version = config.get<string>('version');
    const solver = config.get<string>('solver');
    const keywordDataPath = config.get<string>('cmghelp.keywordDataPath');
    return { rootPrefix, version, solver, keywordDataPath };
}

/**
 * Carrega do arquivo CMGKeywords.json para popular tanto o mergedKeywords
 * quanto o availableVersion. O c√≥digo tenta priorizar as keywords do solver
 * escolhido (GEM,IMEX,STARS) trazendo tamb√©m as keywords dos outros solvers
 * para serem resolvidas caso o solver configurado  n√£o tenha determinada keyword.
 * @param rootPrefix
 * @param version
 * @param preferredSolver
 * @returns {MergedKeywords,availableVersions}
 */
function loadKeywordData(rootPrefix: string, version: string, preferredSolver: string) {

    let { keywordDataPath } = getExtensionConfig();

    // Se o caminho n√£o foi definido, usa o diret√≥rio home do usu√°rio como padr√£o
    if (!keywordDataPath) {
        const homeDir = require('os').homedir();  // Diret√≥rio home do usu√°rio
        keywordDataPath = path.join(homeDir, 'CMGKeywords.json');
    }

    if (!fs.existsSync(keywordDataPath)) {
        vscode.window.showErrorMessage(`O arquivo CMGKeywords.json n√£o foi encontrado no caminho: ${keywordDataPath}`);
        outLog.appendLine(`Verifique se o caminho est√° correto: ${keywordDataPath}`);
        return null;
    }

    const rawData = fs.readFileSync(keywordDataPath, 'utf8');
    const keywordData = JSON.parse(rawData);
    const availableVersions = Object.keys(keywordData.versions);

    // Verifica se a vers√£o existe
    if (!keywordData.versions[version]) {
        vscode.window.showInformationMessage(`A vers√£o ${version} n√£o foi encontrada no CMGKeywords.json. Vou usar ${availableVersions[0]}.`);
        outLog.appendLine(`As vers√µes dispon√≠veis s√£o: ${availableVersions.join(', ')}`);
        outLog.appendLine(`A vers√£o ${version} n√£o foi encontrada no CMGKeywords.json. Vou usar ${availableVersions[0]}.`);
        version=availableVersions[0];
    }
    const versionData = keywordData.versions[version];
    // Inicializa o objeto para armazenar as keywords mescladas
    let mergedKeywords: MergedKeywords = {};

    // Carregar o solver n√£o preferido primeiro
    const solverOrder =
        preferredSolver === 'IMEX' ? ['STARS', 'GEM', 'IMEX'] :
        preferredSolver === 'GEM' ? ['STARS', 'IMEX', 'GEM'] :
        preferredSolver === 'STARS' ? ['IMEX', 'GEM', 'STARS'] : [];

    for (const order of solverOrder) {
        if (versionData[order]) {
            mergedKeywords = { ...versionData[order] };  // Carrega as keywords do solver n√£o preferido
        }
    }

    // Carregar o solver preferido depois, sobrescrevendo quaisquer conflitos de keyword
    if (versionData[preferredSolver]) {
        mergedKeywords = { ...mergedKeywords, ...versionData[preferredSolver] };  // Sobrescreve com o solver preferido
    }

    return { mergedKeywords, availableVersions};  // Retorna as keywords mescladas
}

// Fun√ß√£o para buscar a keyword com base nas configura√ß√µes do usu√°rio
function searchKeyword(keyword: string) {
    const solverData = mergedKeywords[keyword];

    if (!solverData) {
        //vscode.window.showErrorMessage(`A keyword ${keyword} n√£o foi encontrada para o solver ${solver}.`);
        console.error(`A keyword ${keyword} n√£o foi encontrada`);
        return null;
    }

    return solverData;
}

export function activate(context: vscode.ExtensionContext) {
    outLog = vscode.window.createOutputChannel('CMG Help Logs');
    outLog.appendLine('CMG Help extension has been activated');

    let cmgShowLogs = vscode.commands.registerCommand('cmghelp.showLogs', () => {
        outLog.show();  // Exibe o canal de sa√≠da no painel Output
        outLog.appendLine('Log information: Command executed');
    });
    context.subscriptions.push(cmgShowLogs);

    const { rootPrefix, version, solver } = getExtensionConfig();
    if (!rootPrefix || !version || !solver) {
        return new vscode.Hover('Configura√ß√µes de rootPrefix, vers√£o ou solver n√£o est√£o definidas.');
    }
    const result = loadKeywordData(rootPrefix, version, solver);
    if (result) {
        mergedKeywords = result.mergedKeywords;
        availableVersions  = result.availableVersions;
    }
    else {
        return new vscode.Hover('O arquivo keywordData.json n√£o foi carregado corretamente.');
    }

    // HoverProvider para exibir a descri√ß√£o sint√©tica ao passar o mouse sobre uma keyword
    const hoverProvider = vscode.languages.registerHoverProvider(
        { scheme: 'file', pattern: '**/*.{dat,inc}' }, {
        provideHover(document, position, token) {
            const isDisable = vscode.workspace.getConfiguration().get('cmghelp.disable', false);
            if (isDisable) {
                return null;
            }
            const range = document.getWordRangeAtPosition(position);
            const lineText = document.lineAt(position).text.trim();  // Captura a linha completa onde o cursor est√°

            // Verificar se a linha come√ßa com a keyword no formato correto (pode ter espa√ßos ou * antes)
            const keywordPattern = /^[\s\*]*([A-Z-]{2,}[A-Z0-9-]*)/;
            const match = lineText.match(keywordPattern);

            if (!match) {
              // Se a keyword n√£o corresponder ao padr√£o ou n√£o estiver na posi√ß√£o correta, n√£o fa√ßa nada
              return;
            }

            const keyword = match[1].toUpperCase().trim();  // Extrai a keyword do match

            outLog.appendLine(`Keyword capturada no hover: ${keyword}`);

            const keywordInfo = searchKeyword(keyword);

            if (!keywordInfo) {
              return new vscode.Hover(`Nenhuma documenta√ß√£o encontrada para a keyword: ${keyword}`);
            }

            const hoverContent = new vscode.MarkdownString();
            hoverContent.appendMarkdown(`üìñ **${keyword}**\n\n`);
            hoverContent.appendMarkdown(`${keywordInfo.description}\n\n`);
            outLog.appendLine(`Keyword passada para o comando cmghelp.openKeywordDocumentation: ${keyword}`);
            hoverContent.appendMarkdown(`üîó [Mais informa√ß√µes](command:cmghelp.openKeywordDocumentation?${encodeURIComponent(JSON.stringify(keyword))})`);

            // Permitir que o link de "Mais informa√ß√µes" seja clic√°vel
            hoverContent.isTrusted = true;

            return new vscode.Hover(hoverContent);
        }
    });

    context.subscriptions.push(hoverProvider);

    /**
     * Carrega o arquivo htm da documenta√ß√£o, para a keyword escolhida e
     * apresenta no webview. O htm √© preprocessado para permitir funcionar
     * corretamente no webview.
     */
    vscode.commands.registerCommand('cmghelp.openKeywordDocumentation', (keyword: string) => {
        const { rootPrefix, version, solver } = getExtensionConfig();
        //outLog.appendLine('Config loaded:', rootPrefix, version, solver );
        outLog.appendLine(`** Vou buscar pela keyword: ${keyword}`);

        if (!rootPrefix || !version || !solver) {
            vscode.window.showErrorMessage('Configura√ß√µes de rootPrefix, vers√£o ou solver n√£o est√£o definidas.');
            return;
        }

        if (!mergedKeywords) {
            outLog.appendLine(`N√£o h√° uma estrutura de dados de keywords carregada em mem√≥ria`);
            return;
        }

        let keywordInfo = searchKeyword(keyword);

        if (!keywordInfo) {
            vscode.window.showErrorMessage(`Keyword ${keyword} n√£o encontrada em mem√≥ria`);
            return;
        }

        let htmlFilePath = path.join(rootPrefix, version, keywordInfo.file);

        // Verifica se o arquivo existe
        if (!fs.existsSync(htmlFilePath)) {
            for (const version of availableVersions) {
                htmlFilePath = path.join(rootPrefix, version, keywordInfo.file);
                if (fs.existsSync(htmlFilePath)) {
                    outLog.appendLine(`Encontrados os manuais em ${htmlFilePath}`);
                    break;
                }
                vscode.window.showErrorMessage(`A pasta de instala√ß√£o do CMG (${htmlFilePath}) para os manuais n√£o foi encontrada.`);
                return;
            }
        }

        const panel = vscode.window.createWebviewPanel(
            'keywordDocumentation',
            `${keyword} Doc`,
            vscode.ViewColumn.One,
            {
                enableScripts: true,
                localResourceRoots: [
                    vscode.Uri.file(path.dirname(htmlFilePath)),
                    vscode.Uri.file(rootPrefix)
                ]
            }
        );

        // L√™ o arquivo HTML e ajusta os caminhos das imagens
        fs.readFile(htmlFilePath, 'utf8', (err, data) => {
            outLog.appendLine(`Tentando abrir a keyword: ${keyword} no arquivo ${htmlFilePath}`);
            if (err) {
                vscode.window.showErrorMessage(`Erro ao carregar o arquivo HTML: ${err.message}`);
                return;
            }

            const adjustedHtmlContent = adjustHtmlReferences(data, htmlFilePath, panel);
            panel.webview.html = adjustedHtmlContent;
        });
    });

    /**
     * Comando para habilitar a extens√£o
     */
    vscode.commands.registerCommand('cmghelp.enable', () => {
        // Atualizar a configura√ß√£o para definir cmghelp.disable como false
        vscode.workspace.getConfiguration().update('cmghelp.disable', false, vscode.ConfigurationTarget.Global)
            .then(() => {
                vscode.window.showInformationMessage('CMG Help has been enabled.');
                outLog.appendLine('CMG Help has been enabled.');
            }, err => {
                vscode.window.showErrorMessage(`Failed to enable CMG Help: ${err}`);
                outLog.appendLine(`Failed to enable CMG Help: ${err}`);
            });
    });

    /**
     * Comando para desabilitar a extens√£o
     */
    vscode.commands.registerCommand('cmghelp.disable', () => {
        // Atualizar a configura√ß√£o para definir cmghelp.disable como true
        vscode.workspace.getConfiguration().update('cmghelp.disable', true, vscode.ConfigurationTarget.Global)
            .then(() => {
                vscode.window.showInformationMessage('CMG Help has been disabled.');
                outLog.appendLine('CMG Help has been disabled.');
            }, err => {
                vscode.window.showErrorMessage(`Failed to disable CMG Help: ${err}`);
                outLog.appendLine(`Failed to disable CMG Help: ${err}`);
            });
    });

    /**
     * Altera os links do htm carregado para funcionar com o esquema asWebView do VSCODE
     */
    function adjustHtmlReferences(htmlContent: string, htmlFilePath: string, panel: vscode.WebviewPanel): string {
        // Ajustar refer√™ncias de CSS
        htmlContent = htmlContent.replace(/<link.*?href="(.*?)".*?>/g, (match, cssPath) => {
            const cssUri = panel.webview.asWebviewUri(vscode.Uri.file(path.join(path.dirname(htmlFilePath), cssPath)));
            return match.replace(cssPath, cssUri.toString());
        });

        // Ajustar refer√™ncias de JS
        htmlContent = htmlContent.replace(/<script.*?src="(.*?)".*?>/g, (match, jsPath) => {
            const jsUri = panel.webview.asWebviewUri(vscode.Uri.file(path.join(path.dirname(htmlFilePath), jsPath)));
            return match.replace(jsPath, jsUri.toString());
        });

        // Ajustar refer√™ncias de imagens (como SVG)
        htmlContent = htmlContent.replace(/<img.*?src="(.*?)".*?>/g, (match, imgPath) => {
            const imgUri = panel.webview.asWebviewUri(vscode.Uri.file(path.join(path.dirname(htmlFilePath), imgPath)));
            return match.replace(imgPath, imgUri.toString());
        });

        //Ajustar links internos para abrir no WebView
        htmlContent = htmlContent.replace(/<a.*?href="(.*?)".*?>/g, (match, linkPath) => {
            const keyword = path.basename(linkPath, path.extname(linkPath)).toUpperCase();
            return match.replace(linkPath, `command:cmghelp.openKeywordDocumentation?${encodeURIComponent(JSON.stringify(linkPath))}`);
        });

        htmlContent = htmlContent.replace(/<a.*?href="(.*?)".*?>/g, (match, linkPath) => {
            const keyword = path.basename(linkPath, path.extname(linkPath)).toUpperCase();
            return match.replace(linkPath, `command:cmghelp.openKeywordDocumentation?${encodeURIComponent(JSON.stringify(linkPath))}`);
        });

        // Adicionar script para capturar cliques em links
        const script = `
        <script>
            (function() {
                const vscode = window.acquireVsCodeApi(); // Chama apenas uma vez
                document.addEventListener('click', function(event) {
                    const target = event.target.closest('a');
                    if (target && target.href.startsWith('command:cmghelp.openKeywordDocumentation')) {
                        event.preventDefault();
                        const commandUri = target.href.split('command:')[1];
                        vscode.postMessage({ command: commandUri }); // Envia mensagens usando a inst√¢ncia armazenada
                    }
                });
            })();
        </script>
        `;
        return htmlContent + script;
    }
}
